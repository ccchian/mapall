<!DOCTYPE html>
<html lang="en">
 
<head>
 
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <meta name="description" content="">
   <meta name="author" content="">
 
   <title>去哪 +1</title>
 
   <!-- Bootstrap Core CSS -->
   <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
 
   <!-- Custom Fonts -->
   <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
   <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic"
       rel="stylesheet" type="text/css">
   <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">
   <!--Leaflet CSS-->
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
   <!-- Leaflet JavaScript Make sure you put this AFTER Leaflet's CSS -->
   <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
   <!--jQuery-->
   <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
   <!-- Custom CSS -->
   <link href="css/stylish-portfolio.min.css" rel="stylesheet">
 
</head>
 
<body id="page-top">
 
   <!-- Navigation -->
   <a class="menu-toggle rounded" href="#">
       <i class="fas fa-bars"></i>
   </a>
   <nav id="sidebar-wrapper">
       <ul class="sidebar-nav">
           <li class="sidebar-brand">
               <a class="js-scroll-trigger" href="#page-top">去哪+1</a>
           </li>
           <li class="sidebar-nav-item">
               <a class="js-scroll-trigger" href="#page-top">主頁</a>
           </li>
           <li class="sidebar-nav-item">
               <a class="js-scroll-trigger" href="#about">關於</a>
           </li>
           <li class="sidebar-nav-item">
               <a class="js-scroll-trigger" href="#services">如何使用</a>
           </li>
           <li class="sidebar-nav-item">
               <a class="js-scroll-trigger" href="#portfolio">活動行事曆</a>
           </li>
           <li class="sidebar-nav-item">
               <a class="js-scroll-trigger" href="#contact">現在位置找活動</a>
           </li>
       </ul>
   </nav>
 
   <!-- Header -->
   <header class="masthead d-flex">
       <div class="container text-center my-auto">
           <h1 class="mb-1">去哪 ＋1</h1>
           <h3 class="mb-5">
               <em>大台南的資源網站</em>
           </h3>
           <a class="btn btn-primary btn-xl js-scroll-trigger" href="#about">關於我</a>
       </div>
       <div class="overlay"></div>
   </header>
 
   <!-- About -->
   <section class="content-section bg-light" id="about">
       <div class="container text-center">
           <div class="row">
               <div class="col-lg-10 mx-auto">
                   <h2>一個整合大台南地區活動的網站</h2>
                   <p class="lead mb-5">網羅各式藝文活動、也可以自行辦理讀書會、party等，深入體驗台南古都
 
                       <a href="https://unsplash.com/">立即加入會員 </a>!</p>
                   <a class="btn btn-dark btn-xl js-scroll-trigger" href="#services">加入會員</a>
               </div>
           </div>
       </div>
   </section>
 
   <!-- 活動搜尋 -->
   <section class="content-section bg-primary text-white text-center" id="services">
       <div class="container">
           <div class="content-section-heading">
               <h3 class="text-secondary mb-0">如何找到最適合你的活動呢？</h3>
               <h2 class="mb-5">活動搜尋方式</h2>
           </div>
           <div class="row">
               <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
                   <span class="service-icon rounded-circle mx-auto mb-3">
                       <i class="icon-screen-smartphone"></i>
                   </span>
                   <h4>
                       <strong>行事曆查看</strong>
                   </h4>
                   <p class="text-faded mb-0">查看所有的活動後，可以自行加入變成專屬於你的活動行事曆</p>
               </div>
               <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
                   <span class="service-icon rounded-circle mx-auto mb-3">
                       <i class="icon-pencil"></i>
                   </span>
                   <h4>
                       <strong>地圖搜尋</strong>
                   </h4>
                   <p class="text-faded mb-0">根據所在位置或是輸入特定位置找到活動</p>
               </div>
               <div class="col-lg-3 col-md-6 mb-5 mb-md-0">
                   <span class="service-icon rounded-circle mx-auto mb-3">
                       <i class="icon-like"></i>
                   </span>
                   <h4>
                       <strong>參考排行榜</strong>
                   </h4>
                   <p class="text-faded mb-0">快來看看其他人都參加了什麼活動
                       <i class="fas fa-heart"></i>
                   </p>
               </div>
               <div class="col-lg-3 col-md-6">
                   <span class="service-icon rounded-circle mx-auto mb-3">
                       <i class="icon-mustache"></i>
                   </span>
                   <h4>
                       <strong>不如自己來辦一場吧！</strong>
                   </h4>
                   <p class="text-faded mb-0">找不到想參加的活動？不如自己辦一場吧！</p>
               </div>
           </div>
       </div>
   </section>
 
   <!-- Callout -->
   <section class="callout">
       <div class="container text-center">
           <h2 class="mx-auto mb-5">近期活動
               行事曆</h2>
           <a class="btn btn-primary btn-xl" href="https://startbootstrap.com/themes/stylish-portfolio/">Download
               Now!</a>
       </div>
   </section>
 
   <!-- Portfolio -->
   <section class="content-section" id="portfolio">
       <div class="container">
           <div class="content-section-heading text-center">
               <h3 class="text-secondary mb-0"></h3>
               <h2 class="mb-5">現在就來尋找離你最近的活動吧！！</h2>
           </div>
 
           <!-- Call to Action -->
 
           <!-- Map -->
           <input type="button" class="btn btn-dark" id="jsGeoBtn" value="我在哪">
           <div id="mapid" class="map">
 
           </div>
 
           <!-- Footer -->
           <footer class="footer text-center">
               <div class="container">
                   <ul class="list-inline mb-5">
                       <li class="list-inline-item">
                           <a class="social-link rounded-circle text-white mr-3" href="#!">
                               <i class="icon-social-facebook"></i>
                           </a>
                       </li>
                       <li class="list-inline-item">
                           <a class="social-link rounded-circle text-white mr-3" href="#!">
                               <i class="icon-social-twitter"></i>
                           </a>
                       </li>
                       <li class="list-inline-item">
                           <a class="social-link rounded-circle text-white" href="#!">
                               <i class="icon-social-github"></i>
                           </a>
                       </li>
                   </ul>
 
               </div>
           </footer>
           <script>
               //===variables===
               var myLocation = [22.997510, 120.212761];   // default location 台南車站[latitude, longitude]
               //myMarker = null;                        // my location marker
               let myMap;
               let markers = null;                         // MarkerClusterGroup
               let range = 0.8;                            // add to menu list if location is in this range
               let activities = null;                      // total activities data
               let activityItems = [];                     // save generated activiy info
               let activityMarkers = {};                   // save generated activity markers
               let nMaskAdult = 0;
               let nMaskChild = 0;
               let isGPSCatched = false;                   // check if gps is catched
               const getCityDatas = './assets/CityCountyData.json';
               const gerAreaLatLng = 'TainanArea.json';
               const getActivityData = "activity.json"
               //===icons===
               //紫色icon 標示定位
               let violetIcon = new L.Icon({
                   iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                   shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                   iconSize: [25, 41],
                   iconAnchor: [12, 41],
                   popupAnchor: [1, -34],
                   shadowSize: [41, 41]
               });
               //紫色
               let greenIcon = new L.Icon({
                   iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                   shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                   iconSize: [25, 41],
                   iconAnchor: [12, 41],
                   popupAnchor: [1, -34],
                   shadowSize: [41, 41]
               });
 
               //======== 載入MAP ===========
               //$('#mapid').height(window.innerHeight);
 
               //initialize the map on the "map" div with a given center and zoom
               myMap = L.map('mapid').setView(myLocation, 13);
               //即時監控位置 會對更新頁面影響到地圖 待研究 myMap.locate({ setView: true, watch: true });
               // Add base map layer into the map
               L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                   attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
               }).addTo(myMap);
 
               //====兩點距=======
               // 先得到input的經緯度用迴圈
               // if 相距小於等於800m 存成一個array
               let meters2 = myMap.distance(myLocation, [22.992747, 120.207896]);
               console.log(meters2);
 
               function onMapClick(e) {
                   // 顯示點擊區域經緯
                   alert("You clicked the map at " + e.latlng);
               }
               myMap.on('click', onMapClick);
 
 
               //定義現在位置
               const myMarker = L.marker(myLocation, { icon: violetIcon }).addTo(myMap);
 
               if ('geolocation' in navigator) {
                   alert("Geolocation available");
                   navigator.geolocation.getCurrentPosition((position) => {
                       const lat = position.coords.latitude;
                       const lon = position.coords.longitude;
                       document.getElementById('latitude').textContent = lat;
                       document.getElementById('longitude').textContent = lon;
                       myLocation = [lat, lon]
 
 
                       // 找出你在哪並顯示marker
                       myMap.setView([lat, lon], 13);
                       myMarker.setLatLng([lat, lon]).bindPopup(`<h6>Here!</h6>`).openPopup();
 
                       //定位按鈕動作
                       let geoBtn = document.getElementById('jsGeoBtn');
                       geoBtn.addEventListener('click', function () {
                           myMap.setView([lat, lon], 17);
                           myMarker.setLatLng([lat, lon]).bindPopup(
                               `<h6>Here!</h6>`)
                               .openPopup();
                       }, false);
                   });
               } else {
                   alert("Geolocation is not supported by this browser.");
               }
 
               //渲染活動資料列表
               inputActivityData();
               activityListPanel();
 
               async function activityListPanel(areaSelected) {
                   const response = await fetch(getActivityData);
                   const data = await response.json();
                   let str = "";
                   document.getElementById("activity-list").innerHTML = str;
                   for (let i = 0; i < data.length; i++) {
                       const cityName = data[i].city_name;
                       const areaName = data[i].area_name;
                       const roadName = data[i].road_name;
                       const activityName = data[i].activity_name;
 
 
                       if (cityName == "臺南市" && areaName == areaSelected) {
                           str = "";
                           str += `<div class="list-group">
           <a href="#" class="list-group-item list-group-item-action">
           <div class="d-flex w-100 justify-content-between">
           <h6 class="mb-1">${activityName}</h6></div>
           <p class="mb-1">${areaName}${roadName}</p>
           </a></div>`;
                           document.getElementById("activity-list").innerHTML = str;
                       }
                       console.log("outside if");
                   }
 
               }
 
 
               //圖資框架呈現 ＋ 第三方open data JSON
               async function inputActivityData() {
                   const response = await fetch(getActivityData);
                   const data = await response.json();
                   for (let i = 0; i < data.length; i++) {
                       const inputlat = data[i].latitude;
                       const inputlon = data[i].longitude;
                       const activityName = data[i].activity_name;
                       L.marker([inputlat, inputlon], { icon: greenIcon }).addTo(myMap)
                           .bindPopup(
                               '<h3>' + activityName + '</h3>')
                   }
               }
               var inputData = [
                   { 'name': '台南文化中心', lat: 22.975388, lng: 120.225256, 'ttime': '周一休息' },
                   { 'name': '台南文化創意產業園區', lat: 22.998976, lng: 120.212987, 'ttime': '週一至週五 24小時，週末13:00-18:00' },
                   { 'name': '色之古市集', lat: 22.9939459, lng: 120.1956167, 'ttime': '不定時舉辦' },
                   { 'name': '有機產品市集', lat: 22.9809889, lng: 120.2089582, 'ttime': '每週六 7:00' },
                   { 'name': '永成文創跳蚤市集', lat: 22.9479173, lng: 120.1934863, 'ttime': '每週末9:00-17:00' },
                   { 'name': '神農文創市集', lat: 22.9975086, lng: 120.1945734, 'ttime': '周二公休 週三至週一14:00-21:00' },
               ]
               for (var i = 0; inputData.length > i; i++) {
                   L.marker([inputData[i].lat, inputData[i].lng], { icon: greenIcon }).addTo(myMap)
                       .bindPopup(
                           '<h1>' + inputData[i].name + '</h1>'
                           + '<h3>營業時間：' + inputData[i].ttime + '</h3>')
               }
 
               var inputData2 = [
                   { 'name': '美術館一館', lat: 22.9909789, lng: 120.3015429, 'ttime': '週一公休 其餘10:00-18:00' },
                   { 'name': '美術館二館', lat: 22.990438, lng: 120.2000276, 'ttime': '週一公休 其餘10:00-18:00' },
                   { 'name': '東門美術館', lat: 22.9909789, lng: 120.2028781, 'ttime': '週日、週一公休 其餘10:00-18:00' },
                   { 'name': '大新美術館', lat: 23.0081789, lng: 120.2052998, 'ttime': '週一公休 其餘08:00-17:00 中午12:00-13:00休息' },
                   { 'name': '街道美術館PLUS', lat: 22.9968605, lng: 120.1951074, 'ttime': '24小時' },
                   { 'name': 'Akui美術館', lat: 23.0155128, lng: 120.2230215, 'ttime': '週五至週二13:00-18:00' },
                   { 'name': '耘非凡美術館', lat: 22.9848808, lng: 120.2194238, 'ttime': '週一公休 其餘10:00-18:00' },
                   { 'name': '南南美術館', lat: 22.9881776, lng: 120.1936481, 'ttime': '週一公休 其餘10:00-18:00' },
               ]
               for (var i = 0; inputData2.length > i; i++) {
                   L.marker([inputData2[i].lat, inputData2[i].lng],).addTo(myMap)
                       .bindPopup(
                           '<h1>' + inputData2[i].name + '</h1>'
                           + '<h3>營業時間：' + inputData2[i].ttime + '</h3>')
               }
 
               //連動選單
               //縣市選單選項
               async function crateCityOption() {
                   const citySelect = document.getElementById('city');
                   const response = await fetch(getCityDatas);
                   const data = await response.json();
                   let cityOptionHTML = "";
                   // for (let i = 0; i < data.length; i++) {
                   //     //console.log(data[i].CityName);//台北市
                   //     cityOptionHTML += `<option value="${data[i].CityName}">${data[i].CityName}</option>`;
                   // }
                   cityOptionHTML = `<option value="" selected disabled>選縣市</option><option value="臺南市">臺南市</option><option value="高雄市">高雄市</option>`
                   //輸出在選單中
                   citySelect.innerHTML = cityOptionHTML;
                   document.getElementById('city').addEventListener('change', function () {
                       const citySelected = document.getElementById('city').value; // 取得台南市string
                       createAreaOption(citySelected);
                   })
               }
 
               // 輸出鄉鎮選單選項
               async function createAreaOption(citySelected) {
                   const areaSelect = document.getElementById('area');
                   const response = await fetch(getCityDatas);
                   const data = await response.json();
                   const citySelectedObj = data.find(item => item.CityName === citySelected);
                   //console.log(citySelectedObj) //= { CityName: "桃園市", CityEngName: "Taoyuan City", AreaList: Array }
                   const areaArray = citySelectedObj.AreaList;
                   let areaOptionHTML = "";
                   for (let i = 0; i < areaArray.length; i++) {
                       areaOptionHTML += `<option value="${areaArray[i].AreaName}">${areaArray[i].AreaName}</option>`;
                   }
 
                   // 輸出在選單中
                   areaSelect.innerHTML = areaOptionHTML;
                   document.getElementById('area').addEventListener('change', function () {
                       var areaSelected = document.getElementById('area').value; // 取得東區string
                       reLocationArea(areaSelected);
                   })
               }
               // 地址連動地圖
               async function reLocationArea(areaSelected) {
                   const response = await fetch(gerAreaLatLng);
                   const data = await response.json();
                   for (let j = 0; j < data.length; j++) {
                       if (data[j][0] === areaSelected) {
                           myMap.setView([data[j][1][0], data[j][1][1]], 13);
                           activityListPanel(areaSelected);
                       }
                   }
               }
               crateCityOption();
 
 
               // 距離按鈕
               document.getElementById('nearby').addEventListener('change', function () {
                   var distSelected = document.getElementById('nearby').value; //得dist-800
                   distanceCal(distSelected);
               })
 
               //算活動列表個距離
               async function distanceCal(distSelected) {
                   const response = await fetch(getActivityData);
                   const data = await response.json();
                   var d800 = [];
                   var d1200 = [];
                   var d2000 = [];
                   let str = "";
                   let str1 = "";
                   let str2 = "";
                   document.getElementById("activity-list").innerHTML = str;
                   if (distSelected === "dist-800") {
                       for (let i = 0; i < data.length; i++) {
                           const inputlat = data[i].latitude;
                           const inputlon = data[i].longitude;
                           const activityName = data[i].activity_name;
                           const cityName = data[i].city_name;
                           const areaName = data[i].area_name;
                           const roadName = data[i].road_name;
                           let meters = 0;
                           meters = myMap.distance(myLocation, [inputlat, inputlon]);
                           console.log(meters);
                           if (meters < 800) {
                               str += `<div class="list-group">
               <a href="#" class="list-group-item list-group-item-action">
               <div class="d-flex w-100 justify-content-between">
               <h6 class="mb-1">${activityName}</h6></div>
               <p class="mb-1">${areaName}${roadName}</p>
               </a></div>`;
                               console.log(activityName);
                               console.log(str);
                           }
                           document.getElementById("activity-list").innerHTML = str;
                       }
                       myMap.setView(myLocation, 16);
                   }
                   else if (distSelected === "dist-1200") {
                       for (let i = 0; i < data.length; i++) {
                           const inputlat = data[i].latitude;
                           const inputlon = data[i].longitude;
                           const activityName = data[i].activity_name;
                           const cityName = data[i].city_name;
                           const areaName = data[i].area_name;
                           const roadName = data[i].road_name;
                           let meters = 0;
                           meters = myMap.distance(myLocation, [inputlat, inputlon]);
                           console.log(meters);
                           if (meters < 1200) {
                               str += `<div class="list-group">
               <a href="#" class="list-group-item list-group-item-action">
               <div class="d-flex w-100 justify-content-between">
               <h6 class="mb-1">${activityName}</h6></div>
               <p class="mb-1">${areaName}${roadName}</p>
               </a></div>`;
                               document.getElementById("activity-list").innerHTML = str;
                           }
                       }
                       myMap.setView(myLocation, 15);
                   }
                   else if (distSelected === "dist-2000") {
                       for (let i = 0; i < data.length; i++) {
                           const inputlat = data[i].latitude;
                           const inputlon = data[i].longitude;
                           const activityName = data[i].activity_name;
                           const cityName = data[i].city_name;
                           const areaName = data[i].area_name;
                           const roadName = data[i].road_name;
                           let meters = 0;
                           meters = myMap.distance(myLocation, [inputlat, inputlon]);
                           console.log(meters);
                           if (meters < 2000) {
                               str1 = `<div class="overflow-auto">`;
                               str += `<a href="#" class="list-group-item list-group-item-action ">
               <div class="d-flex w-100 justify-content-between">
               <h6 class="mb-1">${activityName}</h6></div>
               <p class="mb-1">${areaName}${roadName}</p>
               </a></div>`;
                               str2 = `</div>`;
 
                               document.getElementById("activity-list").innerHTML = str1 + str + str2;
 
                           }
                       }
                       myMap.setView(myLocation, 14);
                   }
 
               }
 
 
           </script>
           <!-- Scroll to Top Button-->
           <a class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
               <i class="fas fa-angle-up"></i>
           </a>
 
           <!-- Bootstrap core JavaScript -->
           <script src="vendor/jquery/jquery.min.js"></script>
           <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
 
           <!-- Plugin JavaScript -->
           <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
 
           <!-- Custom scripts for this template -->
           <script src="js/stylish-portfolio.min.js"></script>
 
</body>
 
</html>
 
